<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../static/css/download-page.css" th:href="@{/css/download-page.css}">
    <link rel="stylesheet" href="../../static/css/me.css" th:href="@{/css/me.css}">
    <link rel="stylesheet" href="../../static/css/gallery-page.css" th:href="@{/css/gallery-page.css}">
    <link rel="stylesheet" href="../../static/css/wiki-page.css" th:href="@{/css/wiki-page.css}">
    <!-- @{/} 斜杠开头表示相对整个应用根目录，此处必须这样写。不然在提交/admin/modFileManagement请求时会在静态资源路径上加上/admin导致404错误。 -->
    <title>MOD文件管理</title>
</head>
<body>
    <nav class="navbar navbar-dark py-sm-1 fixed-top" id="nav_bar">
        <div class="container-lg row h-100">
            <a class="navbar-brand col-3 h-100" href="./" th:href="@{/}">
                <img src="../../static/images/kuayue_logo.png" th:src="@{/images/kuayue_logo.png}" alt="logo" class="w-25">
                <span class="nav_bar_button"><strong>跨越</strong>&nbsp;|&nbsp;Kuayue</span>
            </a>
            <div class="col-1 h-100 dropdown">
                <a class="nav_bar_button dropdown-toggle" data-bs-toggle="dropdown" href="#">主站</a>
                <ul class="dropdown-menu">
                    <li><a href="#" th:href="@{/download}" class="dropdown-item" target="_blank">下载</a></li>
                    <li><a href="#" th:href="@{/gallery}" class="dropdown-item" target="_blank">画廊</a></li>
                    <li><a href="#" th:href="@{/wiki}" class="dropdown-item" target="_blank">百科</a></li>
                    <li><a href="#" th:href="@{/schematic}" class="dropdown-item" target="_blank">蓝图</a></li>
                    <li><a href="#" th:href="@{/bbs_entrance}" class="dropdown-item" target="_blank">论坛</a></li>
                </ul>
            </div>
            <div class="col-2 h-100 no_padding no_border no_background_color nav_bar_button">
                <a href="../download.html" th:href="@{/admin/modFileManagement}" class="no_text_decoration"><span class="nav_bar_button">MOD文件管理</span></a>
            </div>
            <div class="col-3"></div>

            <div class="col-2 h-100 no_padding no_border no_background_color">
                <div style="float: right">
                    <div class="dropdown">
                        <a class="nav_bar_button dropdown-toggle" data-bs-toggle="dropdown" href="#">
                            <img src="../../static/images/avatar/ayaka1.png" th:src="@{${session.user.avatar}}" style="max-width: 30px">
                            <span th:text="${session.user.nickname}">用户昵称</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a href="#" th:href="@{/admin/user}" class="dropdown-item">个人主页</a></li>
                            <li><a href="#" th:href="@{/admin/logout}" class="dropdown-item">退出登录</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-sm animate__animated animate__fadeIn" style="margin-top: 5em">
        <div class="row">
            <div class="col-11 bg-light" style="border-radius: 10px">
                <h2 style="margin-top: 0.5em; margin-left: 0.2em" class="m-xiaokai">上传MOD文件</h2>
                <hr>
                <form th:action="@{/admin/modUpload}" method="post" enctype="multipart/form-data" style="margin-bottom: 0.5em">
                    <div class="mb-3 form-group">
                        <label for="selEnv" class="form-label">选择运行环境：</label>
                        <select class="form-select" id="selEnv" name="env" style="max-width: 450px">
                            <option>forge</option>
                            <option>fabric</option>
                        </select>
                    </div>
                    <div class="mb-3 form-group">
                        <label for="selVersion" class="form-label">选择MC版本：</label>
                        <select class="form-select" id="selVersion" name="MCVersion" style="max-width: 450px">
                            <option>1.20.1</option>
                            <option>1.19.2</option>
                            <option>1.18.2</option>
                        </select>
                    </div>
                    <div class="mb-3 form-group">
                        <input type="file" name="uploadedFile">
                    </div>
                    <div class="mb-3 form-group">
                        <button type="submit" class="btn btn-dark">上传文件</button>
                    </div>
                    <!--注意这里的th文本表达式不应放在外层的div上，不然会将后面的关闭图标一起替换掉。-->
                    <div id="failure-info" th:unless="${#strings.isEmpty(fileUploadMessage)}"
                         class="alert alert-danger col-5" role="alert">
                        <div th:text="${fileUploadMessage}" class="col-10" style="display: inline-block">上传文件失败！</div>
                        <div id="failure-close" class="btn-close" style="display: inline-block; vertical-align: top"></div>
                    </div>
                    <div id="success-info" th:unless="${#strings.isEmpty(uploadSuccessMessage)}"
                         class="alert alert-success col-5" role="alert">
                        <div th:text="${uploadSuccessMessage}" class="col-10" style="display: inline-block">上传文件成功！</div>
                        <div id="success-close" class="btn-close" style="display: inline-block;vertical-align: top"></div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="waypoint" class="container-sm animate__animated animate__fadeIn" style="margin-top: 5em; margin-bottom: 10em">
        <div class="row">
            <div class="col-11 bg-light" style="border-radius: 10px">
                <div>
                    <h2 style="margin-top: 0.5em; margin-left: 0.2em" class="m-xiaokai">文件列表</h2>
                </div>
                <hr>
                <table class="table table-hover">
                    <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>运行环境</th>
                        <th>MOD文件名</th>
                        <th>MC版本</th>
                        <th>下载量</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="file, fileStat : ${allModFiles}">
                        <td th:text="${file.id}">114</td>
                        <td th:text="${file.env}">forge</td>
                        <td th:text="${file.modFileName}">kuayue-0.3.5m-izayoi_sakuya-rc2.jar</td>
                        <td th:text="${file.MCVersion}">1.20.1</td>
                        <td th:text="${file.downloadCounts}">776</td>
                        <td>
                            <a href="#" th:href="@{/admin/modDownload(id = ${file.id})}" class="download_button" style="text-decoration: none">下载</a>

                            <a href="javascript:;" class="download_button" style="text-decoration: none"
                               data-bs-toggle="modal" data-bs-target="#modifyModal"
                               th:data-bs-id="${file.id}" data-bs-id="modify-mod-id"
                               th:data-bs-name="${file.modFileName}" data-bs-name="mod-name"
                               th:data-bs-version="${file.MCVersion}" data-bs-version="mod-version"
                               th:data-bs-env="${file.env}" data-bs-env="mod-env">修改</a>

                            <a href="javascript:;" class="download_button" style="text-decoration: none"
                               data-bs-toggle="modal" data-bs-target="#deleteModal"
                               th:data-bs-whatever="${file.id}" data-bs-whatever="delete-mod-id">删除</a>
                        </td>
                    </tr>
                    <!--/*-->
                    <tr>
                        <td>114</td>
                        <td>forge</td>
                        <td>kuayue-0.3.5m-izayoi_sakuya-rc2.jar</td>
                        <td>1.20.1</td>
                        <td>776</td>
                        <td>
                            <a href="#" class="download_button" style="text-decoration: none">下载</a>
                            <a href="#" class="download_button" style="text-decoration: none">修改</a>
                            <a href="#" class="download_button" style="text-decoration: none">删除</a>
                        </td>
                    </tr>
                    <!--*/-->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<!--    MOD文件删除模态弹窗-->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">删除MOD文件</h5>
                    <img src="../../static/images/hxd3d.png" th:src="@{/images/hxd3d.png}" alt="" style="max-height: 30px">
                </div>
                <div class="modal-body">
                    <form th:action="@{/admin/modDelete}" method="get">
                        <div class="mb-3">
                            <input type="hidden" class="form-control" id="delete-mod-id" name="id">
                            您确定要删除此MOD文件吗？
                        </div>
                        <div style="float: right">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="submit" class="btn btn-primary">确认</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- MOD文件修改模态弹窗 -->
    <div class="modal fade" id="modifyModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">修改MOD文件</h5>
                    <img src="../../static/images/hxd3d.png" th:src="@{/images/hxd3d.png}" alt="" style="max-height: 30px">
                </div>
                <div class="modal-body">
                    <form th:action="@{/admin/modModify}" method="get">
                        <input type="hidden" class="form-control" id="modify-mod-id" name="id">
                        <div class="mb-3">
                            <label for="modify-mod-name" class="col-form-label">文件名</label>
                            <input type="text" class="form-control" id="modify-mod-name" name="modFileName">
                        </div>
                        <div class="mb-3">
                            <label for="modify-mod-env" class="col-form-label">运行环境</label>
                            <select class="form-select" id="modify-mod-env" name="env" style="max-width: 450px">
                                <option>forge</option>
                                <option>fabric</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="modify-mod-version" class="col-form-label">MC版本</label>
                            <select class="form-select" id="modify-mod-version" name="MCVersion" style="max-width: 450px">
                                <option>1.20.1</option>
                                <option>1.19.2</option>
                                <option>1.18.2</option>
                            </select>
                        </div>
                        <div style="float: right">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="submit" class="btn btn-primary">提交修改</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 修改完成后吐司消息 -->
    <div th:unless="${#strings.isEmpty(fileModifyMessage)}" class="toast-container position-fixed bottom-0 start-50 p-3" style="z-index: 5">
        <div id="liveToast" class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <img src="../../static/images/hxd3d.png" th:src="@{/images/hxd3d.png}" alt="" style="max-height: 30px">
                <strong class="me-auto">Kuayue&nbsp;|&nbsp;通知</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                <h5 th:if="${fileModifyMessage} == 'success'" style="text-align: center">MOD文件信息修改成功！</h5>
                <h5 th:if="${fileModifyfailure} == 'failure'" style="color: red; text-align: center">MOD文件信息修改失败！</h5>
            </div>
        </div>
    </div>
    <!-- 删除完成后吐司消息 -->
    <div th:unless="${#strings.isEmpty(fileDeleteMessage)}" class="toast-container position-fixed bottom-0 start-50 p-3" style="z-index: 5">
        <div id="deleteToast" class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <img src="../../static/images/hxd3d.png" th:src="@{/images/hxd3d.png}" alt="" style="max-height: 30px">
                <strong class="me-auto">Kuayue&nbsp;|&nbsp;通知</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                <h5 th:if="${fileDeleteMessage} == 'success'" style="text-align: center">MOD文件删除成功！</h5>
                <h5 th:if="${fileDeleteMessage} == 'failure'" style="color: red; text-align: center">MOD文件删除失败！</h5>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="../../static/lib/bootstrap/js/bootstrap.bundle.min.js" th:src="@{/lib/bootstrap/js/bootstrap.bundle.min.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/waypoints@4.0.1/lib/jquery.waypoints.min.js"></script>
    <script src="../../static/js/home_page.js" th:src="@{/js/home_page.js}"></script>

    <script type="text/javascript">
        $('#failure-close').click(function () {
            $('#failure-info').hide();
        })
        $('#success-close').click(function () {
            $('#success-info').hide();
        })

        let deleteModal = document.getElementById('deleteModal');
        deleteModal.addEventListener('show.bs.modal', function (event) {
            let deleteButton = event.relatedTarget;
            let deleteModId = deleteButton.getAttribute('data-bs-whatever');
            console.log(deleteModId);
            let modalBodyInput = deleteModal.querySelector('#delete-mod-id');
            modalBodyInput.value = deleteModId;
        })

        let modifyModal = document.getElementById('modifyModal');
        modifyModal.addEventListener('show.bs.modal', function (event) {
            let modifyButton = event.relatedTarget;
            let modId = modifyButton.getAttribute('data-bs-id');
            let modName = modifyButton.getAttribute('data-bs-name');
            let modEnv = modifyButton.getAttribute('data-bs-env');
            let modVersion = modifyButton.getAttribute('data-bs-version');
            console.log(modId + '+' + modName);
            let modIdInput = modifyModal.querySelector('#modify-mod-id');
            let modNameInput = modifyModal.querySelector('#modify-mod-name');
            let modEnvInput = modifyModal.querySelector('#modify-mod-env');
            let modVersionInput = modifyModal.querySelector('#modify-mod-version');
            modIdInput.value = modId;
            modNameInput.value = modName;
            modEnvInput.value = modEnv;
            modVersionInput.value = modVersion;
        })
    </script>
</body>
    <style>
        th, td {
            max-width: 500px; /* 设置每列的最大宽度为500像素 */
            overflow: hidden; /* 当内容超过指定宽度时隐藏部分内容 */
            text-overflow: ellipsis; /* 显示省略号(...)来表示被隐藏的文本 */
            white-space: nowrap; /* 不换行 */
        }
    </style>
</html>
